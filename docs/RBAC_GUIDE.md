# üîê H·ªÜ TH·ªêNG PH√ÇN QUY·ªÄN (RBAC) - MEDCLINIC

## üìã T·ªîNG QUAN

H·ªá th·ªëng ph√¢n quy·ªÅn d·ª±a tr√™n vai tr√≤ (Role-Based Access Control) v·ªõi 6 c·∫•p ƒë·ªô:

| Role | T√™n ti·∫øng Vi·ªát | M√¥ t·∫£ | C√≥ th·ªÉ x√≥a/s·ª≠a |
|------|----------------|-------|----------------|
| **SUPER_ADMIN** | Qu·∫£n tr·ªã t·ªëi cao | To√†n quy·ªÅn h·ªá th·ªëng | ‚ùå KH√îNG |
| **ADMIN** | Qu·∫£n tr·ªã vi√™n | Qu·∫£n tr·ªã vi√™n h·ªá th·ªëng | ‚úÖ C√ì |
| **MANAGER** | Qu·∫£n l√Ω | Qu·∫£n l√Ω ph√≤ng ban | ‚úÖ C√ì |
| **DOCTOR** | B√°c sƒ© | Nh√¢n vi√™n y t·∫ø | ‚úÖ C√ì |
| **STAFF** | Nh√¢n vi√™n | Nh√¢n vi√™n h·ªó tr·ª£ | ‚úÖ C√ì |
| **PATIENT** | B·ªánh nh√¢n | Ng∆∞·ªùi d√πng cu·ªëi | ‚úÖ C√ì |

---

## üéØ PH√ÇN C·∫§P QUY·ªÄN

```
SUPER_ADMIN (100) ‚Üê Cao nh·∫•t
    ‚Üì
ADMIN (80)
    ‚Üì
MANAGER (60)
    ‚Üì
DOCTOR (40)
    ‚Üì
STAFF (20)
    ‚Üì
PATIENT (10) ‚Üê Th·∫•p nh·∫•t
```

**Nguy√™n t·∫Øc:** Role cao h∆°n c√≥ th·ªÉ qu·∫£n l√Ω role th·∫•p h∆°n.

---

## üìÅ C·∫§U TR√öC FILES

```
constants/
  ‚îî‚îÄ‚îÄ roles.js              # ƒê·ªãnh nghƒ©a roles, permissions
middleware/
  ‚îî‚îÄ‚îÄ rbac.js               # RBAC middleware
models/
  ‚îî‚îÄ‚îÄ User.js               # User model v·ªõi role field
```

---

## üîß C√ÅC MIDDLEWARE S·∫¥N C√ì

### 1. `requireRole(allowedRoles)`
Y√™u c·∫ßu user ph·∫£i c√≥ 1 trong c√°c role ƒë∆∞·ª£c ph√©p.

```javascript
// Cho ph√©p nhi·ªÅu roles
router.get('/admin', requireRole(['SUPER_ADMIN', 'ADMIN']), (req, res) => {
  res.send('Admin area');
});

// Cho ph√©p 1 role
router.get('/doctor', requireRole('DOCTOR'), (req, res) => {
  res.send('Doctor area');
});
```

### 2. `isAdmin()`
Ch·ªâ cho ph√©p SUPER_ADMIN v√† ADMIN.

```javascript
const { isAdmin } = require('./middleware/rbac');

router.get('/admin/dashboard', isAuthenticated, isAdmin(), (req, res) => {
  res.render('admin/dashboard');
});
```

### 3. `isManager()`
Cho ph√©p SUPER_ADMIN, ADMIN, MANAGER.

```javascript
router.get('/reports', isAuthenticated, isManager(), (req, res) => {
  res.render('reports');
});
```

### 4. `isDoctor()`
Cho ph√©p SUPER_ADMIN, ADMIN, MANAGER, DOCTOR.

```javascript
router.post('/prescriptions', isAuthenticated, isDoctor(), (req, res) => {
  // Create prescription
});
```

### 5. `isStaff()`
Cho ph√©p t·∫•t c·∫£ tr·ª´ PATIENT.

```javascript
router.get('/appointments/all', isAuthenticated, isStaff(), (req, res) => {
  // View all appointments
});
```

### 6. `checkPermission(allowedRoles)`
T∆∞∆°ng t·ª± `requireRole`, nh∆∞ng t√™n r√µ r√†ng h∆°n.

```javascript
const { PERMISSIONS } = require('./constants/roles');

router.delete('/users/:id', 
  isAuthenticated, 
  checkPermission(PERMISSIONS.USER.DELETE),
  (req, res) => {
    // Delete user
  }
);
```

### 7. `canManageUserMiddleware`
Ki·ªÉm tra xem user hi·ªán t·∫°i c√≥ th·ªÉ qu·∫£n l√Ω user kh√°c kh√¥ng.

```javascript
router.put('/users/:id/role', 
  isAuthenticated,
  canManageUserMiddleware,
  (req, res) => {
    // req.currentUser - user ƒëang th·ª±c hi·ªán action
    // req.targetUser - user b·ªã t√°c ƒë·ªông
    
    // Update role
  }
);
```

### 8. `isOwnerOrHigher(getResourceOwnerId)`
Ki·ªÉm tra user c√≥ ph·∫£i owner c·ªßa resource ho·∫∑c c√≥ role cao h∆°n.

```javascript
const { isOwnerOrHigher } = require('./middleware/rbac');
const Medication = require('./models/Medication');

router.delete('/medications/:id',
  isAuthenticated,
  isOwnerOrHigher(async (req) => {
    const med = await Medication.findById(req.params.id);
    return med?.userId; // Return owner ID
  }),
  (req, res) => {
    // Delete medication
  }
);
```

### 9. `attachUserRole`
Attach role info v√†o m·ªçi request (d√πng cho views).

```javascript
// server.js
app.use(attachUserRole);

// Trong EJS views:
<% if (userRole === 'ADMIN') { %>
  <a href="/admin">Admin Panel</a>
<% } %>
```

---

## üéØ PERMISSIONS THEO MODULE

### User Management
```javascript
const { PERMISSIONS } = require('./constants/roles');

// Xem t·∫•t c·∫£ users
PERMISSIONS.USER.VIEW_ALL
// ['SUPER_ADMIN', 'ADMIN', 'MANAGER']

// T·∫°o user m·ªõi
PERMISSIONS.USER.CREATE
// ['SUPER_ADMIN', 'ADMIN']

// Assign role
PERMISSIONS.USER.ASSIGN_ROLE
// ['SUPER_ADMIN', 'ADMIN']
```

### Medical Records
```javascript
// Xem t·∫•t c·∫£ h·ªì s∆°
PERMISSIONS.MEDICAL_RECORD.VIEW_ALL
// ['SUPER_ADMIN', 'ADMIN', 'MANAGER', 'DOCTOR']

// T·∫°o h·ªì s∆° m·ªõi
PERMISSIONS.MEDICAL_RECORD.CREATE
// ['SUPER_ADMIN', 'ADMIN', 'DOCTOR']
```

### Appointments
```javascript
// Xem t·∫•t c·∫£ l·ªãch h·∫πn
PERMISSIONS.APPOINTMENT.VIEW_ALL
// ['SUPER_ADMIN', 'ADMIN', 'MANAGER', 'DOCTOR', 'STAFF']

// Confirm appointment
PERMISSIONS.APPOINTMENT.CONFIRM
// ['SUPER_ADMIN', 'ADMIN', 'DOCTOR', 'STAFF']
```

### Medications
```javascript
// Prescribe (k√™ ƒë∆°n)
PERMISSIONS.MEDICATION.PRESCRIBE
// ['SUPER_ADMIN', 'ADMIN', 'DOCTOR']

// Delete any medication
PERMISSIONS.MEDICATION.DELETE_ANY
// ['SUPER_ADMIN', 'ADMIN']
```

---

## üíª V√ç D·ª§ S·ª¨ D·ª§NG

### 1. Protect m·ªôt route ƒë∆°n gi·∫£n

```javascript
const express = require('express');
const router = express.Router();
const { isAuthenticated } = require('./middleware/auth');
const { isAdmin } = require('./middleware/rbac');

// Ch·ªâ admin m·ªõi v√†o ƒë∆∞·ª£c
router.get('/admin/settings', isAuthenticated, isAdmin(), (req, res) => {
  res.render('admin/settings');
});
```

### 2. Cho ph√©p nhi·ªÅu roles

```javascript
const { requireRole, ROLES } = require('./middleware/rbac');

// Doctor ho·∫∑c Staff
router.get('/patients', 
  isAuthenticated,
  requireRole([ROLES.DOCTOR, ROLES.STAFF]),
  async (req, res) => {
    // Get patients list
  }
);
```

### 3. Check ownership

```javascript
const { isOwnerOrHigher } = require('./middleware/rbac');
const Appointment = require('./models/Appointment');

router.put('/appointments/:id',
  isAuthenticated,
  isOwnerOrHigher(async (req) => {
    const appointment = await Appointment.findById(req.params.id);
    return appointment?.patientId;
  }),
  async (req, res) => {
    // Update appointment
    // req.isOwner s·∫Ω l√† true n·∫øu user l√† owner
  }
);
```

### 4. Trong views (EJS)

```html
<!-- Check role in view -->
<% if (locals.userRole === 'ADMIN' || locals.userRole === 'SUPER_ADMIN') { %>
  <a href="/admin">Admin Panel</a>
<% } %>

<% if (locals.userRole === 'DOCTOR') { %>
  <a href="/prescriptions">K√™ ƒë∆°n thu·ªëc</a>
<% } %>

<!-- User info -->
<p>Welcome, <%= locals.userInfo?.username %></p>
<p>Role: <%= locals.userInfo?.role %></p>
```

---

## üõ†Ô∏è HELPER FUNCTIONS

### 1. Check permission in code

```javascript
const { hasPermission } = require('./constants/roles');

const userRole = req.userRole;
const allowedRoles = ['ADMIN', 'DOCTOR'];

if (hasPermission(userRole, allowedRoles)) {
  // User has permission
}
```

### 2. Check role hierarchy

```javascript
const { hasHigherRole, hasHigherOrEqualRole } = require('./constants/roles');

// Check if ADMIN > DOCTOR
hasHigherRole('ADMIN', 'DOCTOR'); // true

// Check if ADMIN >= ADMIN
hasHigherOrEqualRole('ADMIN', 'ADMIN'); // true
```

### 3. Check if can manage user

```javascript
const { canManageUser } = require('./constants/roles');

// ADMIN can manage DOCTOR?
canManageUser('ADMIN', 'DOCTOR'); // true

// DOCTOR can manage ADMIN?
canManageUser('DOCTOR', 'ADMIN'); // false

// Anyone can manage SUPER_ADMIN?
canManageUser('ADMIN', 'SUPER_ADMIN'); // false
```

---

## üé® INTEGRATE V√ÄO APP

### 1. Update server.js

```javascript
const { attachUserRole } = require('./middleware/rbac');

// Attach user role to all requests
app.use(attachUserRole);

// Routes with RBAC
const adminRoutes = require('./routes/admin');
app.use('/admin', adminRoutes);
```

### 2. Create admin routes

```javascript
// routes/admin.js
const express = require('express');
const router = express.Router();
const { isAuthenticated } = require('../middleware/auth');
const { isAdmin } = require('../middleware/rbac');

// All routes require authentication + admin role
router.use(isAuthenticated);
router.use(isAdmin());

router.get('/dashboard', (req, res) => {
  res.render('admin/dashboard');
});

router.get('/users', async (req, res) => {
  const users = await User.find();
  res.render('admin/users', { users });
});

module.exports = router;
```

### 3. Update existing routes

```javascript
// routes/medications.js
const { isOwnerOrHigher } = require('../middleware/rbac');

// Only owner or admin+ can delete
router.delete('/:id',
  isAuthenticated,
  isOwnerOrHigher(async (req) => {
    const med = await Medication.findById(req.params.id);
    return med?.userId;
  }),
  async (req, res) => {
    // Delete logic
  }
);
```

---

## üîí B·∫¢O M·∫¨T

### 1. SUPER_ADMIN kh√¥ng th·ªÉ b·ªã x√≥a/s·ª≠a

```javascript
const { ROLE_DESCRIPTIONS } = require('./constants/roles');

if (targetUser.role === 'SUPER_ADMIN') {
  const roleInfo = ROLE_DESCRIPTIONS.SUPER_ADMIN;
  if (!roleInfo.canBeDeleted) {
    return res.status(403).json({
      message: 'SUPER_ADMIN cannot be deleted'
    });
  }
}
```

### 2. User ch·ªâ qu·∫£n l√Ω ƒë∆∞·ª£c role th·∫•p h∆°n

```javascript
const { canManageUser } = require('./constants/roles');

if (!canManageUser(currentUser.role, targetUser.role)) {
  return res.status(403).json({
    message: 'Cannot manage user with equal or higher role'
  });
}
```

### 3. Deactivate user thay v√¨ x√≥a

```javascript
// User model c√≥ field isActive
const user = await User.findById(userId);
user.isActive = false;
await user.save();
```

---

## üìä MIGRATION DATA

N·∫øu ƒë√£ c√≥ users trong DB, c·∫ßn migrate ƒë·ªÉ th√™m role:

```javascript
// Script: migrate-roles.js
const mongoose = require('mongoose');
const User = require('./models/User');

async function migrateRoles() {
  await mongoose.connect(process.env.MONGO_URI);
  
  // Set all existing users to PATIENT
  await User.updateMany(
    { role: { $exists: false } },
    { $set: { role: 'PATIENT', isActive: true } }
  );
  
  console.log('Migration complete');
  process.exit(0);
}

migrateRoles();
```

Run:
```bash
node migrate-roles.js
```

---

## üß™ TESTING

### Test roles:

```javascript
// Create test users
const superAdmin = await User.create({
  username: 'superadmin',
  email: 'super@example.com',
  password: 'password',
  role: 'SUPER_ADMIN'
});

const admin = await User.create({
  username: 'admin',
  email: 'admin@example.com',
  password: 'password',
  role: 'ADMIN'
});

const doctor = await User.create({
  username: 'doctor',
  email: 'doctor@example.com',
  password: 'password',
  role: 'DOCTOR'
});

const patient = await User.create({
  username: 'patient',
  email: 'patient@example.com',
  password: 'password',
  role: 'PATIENT'
});
```

---

## ‚ùì FAQ

### Q: L√†m sao t·∫°o SUPER_ADMIN ƒë·∫ßu ti√™n?

A: T·∫°o tr·ª±c ti·∫øp trong database ho·∫∑c qua script:

```javascript
const User = require('./models/User');

async function createSuperAdmin() {
  const exists = await User.findOne({ role: 'SUPER_ADMIN' });
  
  if (!exists) {
    await User.create({
      username: 'superadmin',
      email: 'super@medclinic.com',
      password: 'change-this-password',
      fullName: 'Super Administrator',
      role: 'SUPER_ADMIN',
      isActive: true
    });
    
    console.log('‚úÖ SUPER_ADMIN created');
  }
}

createSuperAdmin();
```

### Q: User c√≥ th·ªÉ t·ª± ch·ªçn role khi ƒëƒÉng k√Ω kh√¥ng?

A: **KH√îNG N√äN**. M·∫∑c ƒë·ªãnh n√™n l√† PATIENT, admin assign role sau.

```javascript
// routes/auth.js - Register
const user = new User({
  username,
  email,
  password,
  role: 'PATIENT' // Always default to PATIENT
});
```

### Q: L√†m sao assign role cho user?

A: T·∫°o admin route:

```javascript
// routes/admin.js
router.put('/users/:id/role',
  isAuthenticated,
  isAdmin(),
  canManageUserMiddleware,
  async (req, res) => {
    const { role } = req.body;
    const targetUser = req.targetUser;
    
    targetUser.role = role;
    await targetUser.save();
    
    res.json({ success: true });
  }
);
```

---

## üìù NEXT STEPS

1. ‚úÖ T·∫°o admin dashboard UI
2. ‚úÖ T·∫°o user management page
3. ‚úÖ Apply RBAC v√†o c√°c routes hi·ªán c√≥
4. ‚úÖ T·∫°o doctor dashboard
5. ‚úÖ T·∫°o manager dashboard
6. ‚úÖ Testing to√†n b·ªô h·ªá th·ªëng

---

## üìß Support

Need help? phuocdainguyen2412@gmail.com

---

**üéâ H·ªá th·ªëng RBAC ƒë√£ s·∫µn s√†ng s·ª≠ d·ª•ng!**
